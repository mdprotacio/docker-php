# syntax=docker/dockerfile:1.4
ARG PHP_VERSION=8
ARG PHP_VARIANT=cli
ARG PHP_BASE_VARIANT=cli
ARG BASE_IMAGE_REGISTRY=public.ecr.aws
ARG BASE_IMAGE_PATH=docker/library
FROM ${BASE_IMAGE_REGISTRY}/${BASE_IMAGE_PATH}/composer:latest AS composer
FROM php-${PHP_VERSION}-${PHP_BASE_VARIANT} AS builder

FROM ${BASE_IMAGE_REGISTRY}/${BASE_IMAGE_PATH}/php:${PHP_VERSION}-${PHP_VARIANT} AS runtime
# Add dependencies for PIE
ENV PHPIZE_DEPS="${PHPIZE_DEPS} autoconf automake build-essential gcc git libtool m4 make"
ENV DEBIAN_FRONTEND=noninteractive
# Copy PIE and Composer binaries
COPY --link --from=ghcr.io/php/pie:bin /pie /usr/bin/pie
COPY --link --from=composer /usr/bin/composer /usr/local/bin/composer
COPY --from=builder /usr/local/lib/php/extensions/ /usr/local/lib/php/extensions/

# Replace http package sources with https
RUN sed -i 's|http://|https://|g' /etc/apt/sources.list.d/* \
    && apt-get clean \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        ca-certificates \
        gnupg \
        openssl \
    && update-ca-certificates

# Install dependencies
RUN set -eux; \
    apt-get clean; \
    apt-get update && \
    apt-get install -y --no-install-recommends \
# Add helper tools for development \
        curl \
        gettext-base \
        locales \
        netcat-traditional \
        wget \
# PHP extension dependencies \
        `apt-cache pkgnames libavif | sort -V | head -1` \
        `apt-cache pkgnames libc-ares | sort -V | head -1` \
        `apt-cache pkgnames libc6 | sort -V | head -1` \
        `apt-cache pkgnames libcurl4 | sort -V | head -1` \
        `apt-cache pkgnames libfreetype | sort -V | head -1` \
        `apt-cache pkgnames libicu | grep -v "java" | sort -V | head -1` \
        `apt-cache pkgnames libjpeg | sort -V | head -1` \
        `apt-cache pkgnames libmagickcore | grep -v "extra\|headers\|config\|dev"` \
        `apt-cache pkgnames libmagickwand | grep -v "extra\|headers\|config\|dev"` \
        `apt-cache pkgnames libmcrypt | sort -V | head -1` \
        `apt-cache pkgnames libmemcache | sort -V | head -1` \
        `apt-cache pkgnames libmongo | sort -V | head -1` \
        `apt-cache pkgnames libmsgpack | sort -V | head -1` \
        `apt-cache pkgnames libpng | sort -V | head -1` \
        `apt-cache pkgnames librabbitmq | sort -V | head -1` \
        `apt-cache pkgnames libsqlite3 | sort -V | head -1` \
        `apt-cache pkgnames libwebp | sort -V | head -1` \
        `apt-cache pkgnames libxsl | grep -v dev | sort -V | head -1` \
        `apt-cache pkgnames libzip | grep -v "java" | sort -V | head -1` \
        `apt-cache pkgnames unixodbc | sort -V | head -1` \
        `apt-cache pkgnames zlib | sort -V | head -1` \
    && \
    apt-get clean;

RUN set -eux \
    ; update-ca-certificates \
    ; docker-php-ext-enable --ini-name 0-docker-php-ext-igbinary.ini igbinary \
    ; docker-php-ext-enable --ini-name 0-docker-php-ext-msgpack.ini msgpack \
    ; docker-php-ext-enable --ini-name 0-docker-php-ext-sockets.ini sockets \
    ; cp $PHP_INI_DIR/php.ini-production $PHP_INI_DIR/php.ini \
    ; sed -i "s|^expose_php\s*=\s*\(.*\)|expose_php=Off|g" $PHP_INI_DIR/php.ini \
    ; sed -i "s|^\(;\)*realpath_cache_size\s*=\s*\(.*\)|realpath_cache_size=\2|g" $PHP_INI_DIR/php.ini \
    ; sed -i "s|^\(;\)*realpath_cache_ttl\s*=\s*\(.*\)|realpath_cache_ttl=\2|g" $PHP_INI_DIR/php.ini

WORKDIR /var/www/html

FROM runtime AS apache
RUN set -eux \
# apache tweaks \
    ; a2enmod \
      buffer \
      expires \
      headers \
      mime_magic \
      remoteip \
      rewrite \
    ; sed -i "s|^ServerSignature\(.*\)|ServerSignature Off|g" $APACHE_CONFDIR/conf-enabled/security.conf \
    ; sed -i "s|^ServerTokens\(.*\)|ServerTokens Prod|g" $APACHE_CONFDIR/conf-enabled/security.conf \
    ; echo "LogFormat \"\\\"%{X-Forwarded-For}i %h\\\" %l %u %t \\\"%r\\\" %>s %O \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined" > $APACHE_CONFDIR/conf-available/log_combined.conf \
    ; a2enconf log_combined \
    ;

FROM runtime as cli
CMD ["php", "-a"]

FROM runtime as fpm
RUN set -eux \
    ; sed -i "s/;emergency_restart_threshold\s*=\s*.*/emergency_restart_threshold = 10/g" $PHP_INI_DIR/../php-fpm.conf \
    ; sed -i "s/;emergency_restart_interval\s*=\s*.*/emergency_restart_interval = 1m/g" $PHP_INI_DIR/../php-fpm.conf \
    ; sed -i "s/;process_control_timeout\s*=\s*.*/process_control_timeout = 10s/g" $PHP_INI_DIR/../php-fpm.conf \
    ;
CMD ["php-fpm"]

FROM runtime as zts
CMD ["php", "-a"]
