# This is a basic workflow to help you get started with Actions

name: Build PHP Images and Push to Registries

# Controls when the action will run.
on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]
  schedule:
    - cron: '0 0 1,16 * *'
  workflow_dispatch:
    inputs:
      base_image_registry:
        description: 'Base PHP image registry (docker.io, public.ecr.aws, etc.)'
        required: false
        default: 'docker.io'
        type: choice
        options:
          - public.ecr.aws
          - docker.io

concurrency:
  # PRs: group by PR number; non-PRs: group by branch ref
  group: ${{ github.event_name == 'pull_request' && format('{0}-PR-{1}', github.workflow, github.event.pull_request.number) || format('{0}-{1}', github.workflow, github.ref) }}
  # Only cancel in-progress for PRs; everything else will queue for its group
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  packages: write
  pull-requests: write
  actions: write
  id-token: write
  attestations: write

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  base-images:
    strategy:
      max-parallel: 8
      matrix:
        version:
          - '8.2.30'
          - '8.3.30'
          - '8.4.18'
          - '8.5.3'
        os:
          - alpine
          - debian
        variant:
          - cli
          - zts
    uses: ./.github/workflows/base-build.yml
    secrets: inherit
    with:
      version: ${{ matrix.version }}
      variant: ${{ matrix.variant }}
      os: ${{ matrix.os }}
      base_image_registry: ${{ github.event.inputs.base_image_registry || 'public.ecr.aws' }}
  build-images:
    needs: base-images
    if: needs.base-images.result == 'success'
    strategy:
      max-parallel: 8
      matrix:
        version:
          - '8.2.30'
          - '8.3.30'
          - '8.4.18'
          - '8.5.3'
        os:
          - alpine
          - debian
        variant:
          - apache
          - cli
          - fpm
          - zts
        exclude:
          - variant: apache
            os: alpine
    uses: ./.github/workflows/image-build.yml
    secrets: inherit
    with:
      version: ${{ matrix.version }}
      os: ${{ matrix.os }}
      variant: ${{ matrix.variant }}
      latest: '8.5.3'
      base_image_registry: ${{ github.event.inputs.base_image_registry || 'public.ecr.aws' }}
  cleanup-cache:
    needs: build-images
    if: github.event_name == 'pull_request' && needs.build-images.result == 'success'
    uses: ./.github/workflows/github-cache-cleanup.yml
    secrets: inherit
  build-complete:
    needs: [base-images, build-images, cleanup-cache]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Validate build results
        run: |
          if [ "${{ needs.base-images.result }}" != "success" ] || \
             [ "${{ needs.build-images.result }}" != "success" ]; then
            echo "Upstream build failed â€” blocking merge"
            exit 1
          fi
          echo "All builds completed successfully"
